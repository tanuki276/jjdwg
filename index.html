<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>liefantidia | æ­´å²çš„æ——ãƒ»ç´‹ç« æ¤œç´¢</title> 
    
    <style>
        body { font-family: 'Arial', sans-serif; margin: 0; padding: 0; background-color: #f4f4f9; color: #333; }
        header { background-color: #004d99; color: white; padding: 20px; text-align: center; }
        main { padding: 20px; max-width: 1200px; margin: 0 auto; }
        .search-controls { display: flex; gap: 10px; margin-bottom: 30px; padding: 20px; background-color: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); flex-wrap: wrap; }
        .search-controls input, .search-controls select, .search-controls button { padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; flex-grow: 1; }
        .search-controls button { background-color: #cc0000; color: white; cursor: pointer; border: none; transition: background-color 0.3s; }
        .search-controls button:hover { background-color: #990000; }
        .flags-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
        .flag-card { background-color: white; padding: 15px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); text-align: center; border-left: 5px solid #004d99; }
        .flag-card img { max-width: 100%; height: auto; max-height: 150px; border: 1px solid #eee; margin-bottom: 5px; }
        .flag-card h3 { font-size: 1.1em; margin: 5px 0; }
        .flag-card p { font-size: 0.9em; color: #666; line-height: 1.4; }
        .flag-card button { margin-top: 5px; padding: 5px 10px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em; transition: background-color 0.2s; }
        .flag-card button:hover { background-color: #0056b3; }
        .license-info { margin-top: 10px; padding-top: 5px; border-top: 1px dotted #ccc; font-size: 0.75em; color: #004d99; }
        .license-info a { color: #004d99; text-decoration: none; }
        .license-info a:hover { text-decoration: underline; }
        .hidden { display: none; }
        .error { color: red; font-weight: bold; padding: 20px; white-space: pre-wrap; word-wrap: break-word; text-align: left; border: 1px solid red; background-color: #ffeaea; border-radius: 4px; }
        #summary-container { border: 1px solid #ddd; margin-top: 15px; padding: 20px; background-color: #fff; border-radius: 8px; display: flex; align-items: center; gap: 20px; }
        #summary-image-wrapper { flex-shrink: 0; text-align: center; }
        .summary-image { max-width: 150px; height: auto; border: 1px solid #ccc; display: block; }
        #summary-content { flex-grow: 1; }
        .summary-link { color: #004d99; text-decoration: none; }
        .summary-link:hover { text-decoration: underline; }
        footer { text-align: center; padding: 15px; margin-top: 30px; border-top: 1px solid #ddd; font-size: 0.8em; color: #666; }
    </style>
</head>
<body>

    <header>
        <h1>liefantidia | æ­´å²çš„æ——ãƒ»ç´‹ç« æ¤œç´¢</h1> 
        <p>å›½åã€æ”¿ä½“åã€ã¾ãŸã¯æ——ã®ç¨®é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚**ç¾åœ¨ã€æœŸé–“æƒ…å ±è¡¨ç¤ºã¯ã‚¨ãƒ©ãƒ¼å›é¿ã®ãŸã‚åœæ­¢ä¸­ã§ã™ã€‚**</p>
    </header>

    <main>
        <section class="search-controls">
            <input type="text" id="keyword-input" placeholder="å›½åã‚„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ (ä¾‹: æ¸…æœ, ãƒ‰ã‚¤ãƒ„)" aria-label="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢">
            
            <input type="number" id="year-input" placeholder="å¹´å· (éå¯¾å¿œ)" min="1" max="2025" aria-label="å¹´å·æŒ‡å®š" style="display: none;">
            
            <select id="flag-type-select" aria-label="æ——ã®ç¨®é¡é¸æŠ">
                <option value="">å…¨ã¦ã®ç¨®é¡ (æ——ã¨ç´‹ç« )</option>
                <option value="å›½æ——">å›½æ——</option>
                <option value="è»æ——">è»æ——</option>
                <option value="å•†èˆ¹æ——">å•†èˆ¹æ——</option>
                <option value="æ”¿å…šæ——">æ”¿å…šæ——</option>
                <option value="å›½ç« ">å›½ç« </option>
                <option value="è»è‰¦æ——">è»è‰¦æ——</option>
            </select>

            <button id="search-button">æ¤œç´¢</button>
        </section>

        <section class="results-area">
            <h2>Wikipedia è¨˜äº‹æ¦‚è¦ã¨ä»£è¡¨çš„ãªæ——</h2>
            <div id="summary-container">
                <p id="summary-title" style="margin: 0;"><span style="font-weight: bold;">è¨˜äº‹æƒ…å ±ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</span></p>
                <div id="summary-content"></div>
            </div>

            <h2 style="margin-top: 40px;">é–¢é€£ã™ã‚‹æ——ãƒ»ç´‹ç« ã®ãƒªã‚¹ãƒˆ (<span id="result-count">0</span>ä»¶)</h2>
            <p id="loading-message" class="hidden">æ¤œç´¢ä¸­... (Wikidata Query Serviceã«ç›´æ¥å•ã„åˆã‚ã›ã¦ã„ã¾ã™)</p>
            
            <div id="error-message" class="hidden error"></div>
            
            <div id="flags-container" class="flags-grid">
            </div>
            
        </section>
    </main>

    <footer>
        <p>ãƒ‡ãƒ¼ã‚¿ã¯**Wikidata**ãŠã‚ˆã³**Wikimedia Commons**ã‹ã‚‰å–å¾—ã•ã‚Œã¦ã„ã¾ã™ã€‚</p>
        <p>è‡ªç”±ãªãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã«åŸºã¥ãè¡¨ç¤ºã—ã¦ã„ã¾ã™ãŒã€**å¿…ãšå„ã‚«ãƒ¼ãƒ‰ã®å‡ºå…¸ã‚’ã”ç¢ºèªãã ã•ã„ã€‚**</p>
    </footer>

    <script>
        const WIKIDATA_ENDPOINT = 'https://query.wikidata.org/sparql';
        const NO_YEAR_INFO = 'æœŸé–“æƒ…å ±ãªã— (è² è·å›é¿)';

        // =======================================================
        // ğŸ› ï¸ ã‚¯ã‚¨ãƒªåˆ†é›¢: æ——ã¨ç´‹ç« ã‚’å€‹åˆ¥ã®ã‚¯ã‚¨ãƒªã§å–å¾—ã™ã‚‹
        // =======================================================
        
        function createSimpleSparqlQuery(keyword, typeQID, imageProperty) {
            // QID: Q1197825 (æ——), Q1529158 (ç´‹ç« )
            // imageProperty: wdt:P41 (æ——), wdt:P94 (ç´‹ç« )
            
            return `
                SELECT DISTINCT ?item ?itemLabel ?image ?licenseLabel ?authorLabel ?typeLabel
                WHERE {
                    # 1. ã‚¢ã‚¤ãƒ†ãƒ  ?item ã¯æŒ‡å®šã•ã‚ŒãŸã‚¿ã‚¤ãƒ— (æ—— or ç´‹ç« ) ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
                    ?item wdt:P31 wd:${typeQID}.
                    
                    # 2. ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒãƒãƒ³ã‚° (åŸºæœ¬çš„ãªãƒ©ãƒ™ãƒ«æ¤œç´¢)
                    ?item rdfs:label ?searchString .
                    FILTER(LANG(?searchString) = "ja" || LANG(?searchString) = "en").
                    FILTER(CONTAINS(LCASE(?searchString), LCASE("${keyword}"))).
                    
                    # 3. ç”»åƒãƒ—ãƒ­ãƒ‘ãƒ†ã‚£
                    OPTIONAL { ?item ${imageProperty} ?image. }
                    
                    # 4. ãã®ä»–ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§å–å¾—
                    OPTIONAL { ?item wdt:P170 ?author. } 
                    OPTIONAL { ?item wdt:P6216 ?license. } 
                    
                    SERVICE wikibase:label { 
                        bd:serviceParam wikibase:language "[AUTO_LANGUAGE],ja,en".
                        ?item rdfs:label ?itemLabel.
                        OPTIONAL { ?item wdt:P31 wd:${typeQID}. ?item wdt:P31 ?typeQID. ?typeQID rdfs:label ?typeLabel. }
                        OPTIONAL { ?license rdfs:label ?licenseLabel. }
                        OPTIONAL { ?author rdfs:label ?authorLabel. }
                    }
                }
                LIMIT 30
            `; // LIMITã‚’ä¸‹ã’ã¦è² è·ã‚’è»½æ¸›
        }

        async function fetchWikidata(query) {
            const response = await fetch(WIKIDATA_ENDPOINT, {
                method: 'POST',
                headers: {
                    'Accept': 'application/sparql-results+json',
                    'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'
                },
                body: `query=${encodeURIComponent(query)}`
            });

            if (!response.ok) {
                const errorText = await response.text();
                // è‡´å‘½çš„ãªã‚¨ãƒ©ãƒ¼è©³ç´°ã‚’ã‚¹ãƒ­ãƒ¼
                throw new Error(`Wikidataæ¥ç¶šã‚¨ãƒ©ãƒ¼ (HTTP ${response.status})\n\n[Wikidataã‚µãƒ¼ãƒãƒ¼è©³ç´°æƒ…å ±]\n${errorText}`);
            }

            return response.json();
        }


        function transformWikidataResponse(data) {
            // ... (çœç•¥: å¤‰æ›ãƒ­ã‚¸ãƒƒã‚¯ã¯å‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨åŒã˜ã€‚æœŸé–“æƒ…å ±ã¯ãªã—)
            if (!data.results || !data.results.bindings) return [];

            const flags = data.results.bindings.map(binding => {
                let licenseName = binding.licenseLabel?.value || 'ä¸æ˜ãªãƒ©ã‚¤ã‚»ãƒ³ã‚¹';
                let licenseUrl = '';
                
                if (licenseName.includes('Creative Commons')) {
                    licenseUrl = 'https://creativecommons.org/licenses/by-sa/4.0/deed.ja';
                } else if (licenseName.includes('Public Domain')) {
                    licenseUrl = 'https://ja.wikipedia.org/wiki/%E3%83%91%E3%83%96%E3%83%AA%E3%83%83%E3%82%AF%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3';
                }

                let typeLabel = binding.typeLabel?.value || 'æ——/ç´‹ç« ';
                let simpleType = typeLabel.includes('ç´‹ç« ') || typeLabel.includes('Coat of arms') ? 'å›½ç« ' : 'æ——';

                const id = binding.item?.value; 
                
                return {
                    id: id,
                    name: binding.itemLabel?.value || 'åç§°ä¸æ˜',
                    type: simpleType,
                    start_year: NO_YEAR_INFO,
                    end_year: null, 
                    image_url: binding.image?.value,
                    license_name: licenseName,
                    license_url: licenseUrl,
                    author: binding.authorLabel?.value || 'ä¸æ˜',
                    source: 'Wikidata'
                };
            });
            
            return flags;
        }

        // =======================================================
        // 3. Wikipedia Summary API (ã‚µãƒ ãƒã‚¤ãƒ«ç”»åƒã®ã¿ã‚’å–å¾—ãƒ»è¡¨ç¤º)
        // =======================================================
        
        async function fetchWikipediaSummary(query) {
            // (çœç•¥: Summary APIé–¢æ•°ã¯å¤‰æ›´ãªã—)
            const summaryTitleElement = document.getElementById('summary-title');
            const summaryContentElement = document.getElementById('summary-content');
            
            summaryTitleElement.innerHTML = `<span style="font-weight: bold;">è¨˜äº‹æƒ…å ±ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</span>`;
            summaryContentElement.innerHTML = '';
            
            const apiUrl = `https://ja.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(query)}`;

            try {
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    throw new Error('è¨˜äº‹ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã‹ã€APIå¿œç­”ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
                }
                const data = await response.json();
                
                if (!data.thumbnail) {
                    summaryTitleElement.innerHTML = `è©²å½“ã™ã‚‹Wikipediaè¨˜äº‹ã®ä»£è¡¨ç”»åƒã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚`;
                    return; 
                }

                summaryContentElement.innerHTML = `
                    <div id="summary-image-wrapper">
                        <a href="${data.content_urls.desktop.page}" target="_blank" title="${data.title} - Wikipedia">
                            <img src="${data.thumbnail.source}" class="summary-image" alt="${data.title}ã®ä»£è¡¨ç”»åƒ">
                        </a>
                        <p style="font-size: 0.8em; margin-top: 5px;"><a href="${data.content_urls.desktop.page}" target="_blank" class="summary-link">â†’ è©³ç´°ã‚’è¦‹ã‚‹ (Wikipediaã¸)</a></p>
                    </div>
                `;
                summaryTitleElement.innerHTML = `<span style="font-weight: bold;">Wikipedia: ${data.title}</span>`;


            } catch (error) {
                summaryTitleElement.innerHTML = `<span style="font-weight: bold;">Wikipedia: ${query}</span>`;
                summaryContentElement.innerHTML = `<p class="error-message" style="color:#666; text-align: left; margin: 0;">è©²å½“ã™ã‚‹Wikipediaè¨˜äº‹ã®ä»£è¡¨ç”»åƒã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>`;
            }
        }
        
        // =======================================================
        // ğŸ¨ è¡¨ç¤ºå‡¦ç†é–¢æ•° (Wikidata)
        // =======================================================
        function renderFlags(flags, container) {
            container.innerHTML = '';
            flags.forEach(flag => {
                const card = document.createElement('div');
                card.className = 'flag-card';
                
                const imageUrl = flag.image_url || 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-size="10" fill="#cc0000">ç”»åƒæ¬ è½</text><rect x="0" y="0" width="100" height="100" fill="none" stroke="#ccc" stroke-width="2"/></svg>';
                
                const safeFileName = `${flag.name.replace(/[^a-zA-Z0-9\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]/g, '_')}`;

                const downloadSection = `
                    <a href="${imageUrl}" download="${safeFileName}.svg" title="${flag.name}ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰">
                        <img src="${imageUrl}" alt="${flag.name}">
                    </a>
                    <button onclick="window.open('${imageUrl}', '_blank')">ç”»åƒã‚’åˆ¥ã‚¿ãƒ–ã§é–‹ã</button>
                `;

                card.innerHTML = `
                    ${downloadSection}
                    <h3>${flag.name}</h3>
                    <p>ç¨®é¡: ${flag.type || 'ä¸æ˜'}</p>
                    <p>æœŸé–“: ${NO_YEAR_INFO}</p> 
                    <p style="font-size: 0.8em; color: #004d99;">ãƒ‡ãƒ¼ã‚¿å…ƒ: ${flag.source}</p>
                `;
                
                const licenseInfo = document.createElement('p');
                licenseInfo.className = 'license-info';
                
                let licenseText = 'å‡ºå…¸: ';
                licenseText += flag.author ? `ä½œè€…: ${flag.author}` : `æƒ…å ±æº`;
                
                if (flag.license_name && flag.license_url) {
                    licenseText += `, <a href="${flag.license_url}" target="_blank">${flag.license_name}</a>`;
                } else if (flag.license_name) {
                    licenseText += `, ${flag.license_name}`;
                }

                licenseInfo.innerHTML = licenseText;
                card.appendChild(licenseInfo);
                
                container.appendChild(card);
            });
        }
        
        // =======================================================
        // ğŸ–±ï¸ ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ (æ¤œç´¢å®Ÿè¡Œéƒ¨ - ã‚¯ã‚¨ãƒªåˆ†é›¢ãƒ­ã‚¸ãƒƒã‚¯)
        // =======================================================

        document.getElementById('search-button').addEventListener('click', async () => {
            const keyword = document.getElementById('keyword-input').value.trim();
            const flagsContainer = document.getElementById('flags-container');
            const resultCount = document.getElementById('result-count');
            const loadingMessage = document.getElementById('loading-message');
            const errorMessage = document.getElementById('error-message');

            // è¡¨ç¤ºã‚’ãƒªã‚»ãƒƒãƒˆ
            flagsContainer.innerHTML = '';
            resultCount.textContent = '0';
            errorMessage.classList.add('hidden');
            errorMessage.innerHTML = ''; 
            loadingMessage.classList.remove('hidden');

            if (!keyword) {
                loadingMessage.classList.add('hidden');
                errorMessage.innerHTML = "æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
                errorMessage.classList.remove('hidden');
                return;
            }
            
            // 1. Wikipedia Summary APIã®å®Ÿè¡Œ
            await fetchWikipediaSummary(keyword);
            
            let finalFlags = [];
            let errorOccurred = false;
            let combinedErrorDetails = "";
            
            // æ——æ¤œç´¢ã‚¯ã‚¨ãƒªã®ä½œæˆã¨å®Ÿè¡Œ (QID: æ—— Q1197825, ç”»åƒãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ P41)
            const flagQuery = createSimpleSparqlQuery(keyword, 'Q1197825', 'wdt:P41');
            
            try {
                const flagData = await fetchWikidata(flagQuery);
                finalFlags = finalFlags.concat(transformWikidataResponse(flagData));

            } catch (error) {
                errorOccurred = true;
                combinedErrorDetails += `\n[æ——ã‚¯ã‚¨ãƒªå¤±æ•—] ${error.message}`;
                // SPARQLã‚¯ã‚¨ãƒªå…¨ä½“ã‚’è©³ç´°æƒ…å ±ã¨ã—ã¦è¡¨ç¤ºã™ã‚‹ãŸã‚ã€ã“ã“ã§çµåˆ
                combinedErrorDetails += `\n\n[å¤±æ•—ã—ãŸæ——SPARQLã‚¯ã‚¨ãƒª]\n${flagQuery}`;
            }

            // ç´‹ç« æ¤œç´¢ã‚¯ã‚¨ãƒªã®ä½œæˆã¨å®Ÿè¡Œ (QID: ç´‹ç«  Q1529158, ç”»åƒãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ P94)
            const emblemQuery = createSimpleSparqlQuery(keyword, 'Q1529158', 'wdt:P94');
            
            try {
                const emblemData = await fetchWikidata(emblemQuery);
                finalFlags = finalFlags.concat(transformWikidataResponse(emblemData));
                
            } catch (error) {
                errorOccurred = true;
                combinedErrorDetails += `\n\n[ç´‹ç« ã‚¯ã‚¨ãƒªå¤±æ•—] ${error.message}`;
                // SPARQLã‚¯ã‚¨ãƒªå…¨ä½“ã‚’è©³ç´°æƒ…å ±ã¨ã—ã¦è¡¨ç¤ºã™ã‚‹ãŸã‚ã€ã“ã“ã§çµåˆ
                combinedErrorDetails += `\n\n[å¤±æ•—ã—ãŸç´‹ç« SPARQLã‚¯ã‚¨ãƒª]\n${emblemQuery}`;
            }
            
            // 3. çµæœã®è¡¨ç¤ºã¨ã‚¨ãƒ©ãƒ¼å‡¦ç†
            loadingMessage.classList.add('hidden');
            
            const uniqueFlags = Array.from(new Map(finalFlags.map(item => [item.id, item])).values());
            resultCount.textContent = uniqueFlags.length;
            renderFlags(uniqueFlags, flagsContainer);
            
            if (errorOccurred && combinedErrorDetails) {
                 // å°‘ãªãã¨ã‚‚ã©ã¡ã‚‰ã‹ã®ã‚¯ã‚¨ãƒªã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆ
                errorMessage.innerHTML = `
                    **é‡å¤§ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚å¤–éƒ¨APIãŒå¿œç­”ã—ã¦ã„ã¾ã›ã‚“ã€‚**
                    <pre style="margin-top: 10px; padding: 10px; background: #fff0f0; border: 1px dashed #d00;">${combinedErrorDetails}</pre>
                    æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚
                `;
                errorMessage.classList.remove('hidden');

            } else if (uniqueFlags.length === 0) {
                 // ã‚¨ãƒ©ãƒ¼ã¯ç™ºç”Ÿã—ãªã‹ã£ãŸãŒçµæœãŒã‚¼ãƒ­ã ã£ãŸå ´åˆ
                errorMessage.innerHTML = 'è©²å½“ã™ã‚‹æ——ãƒ»ç´‹ç« ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚';
                errorMessage.classList.remove('hidden');
            } else {
                 errorMessage.classList.add('hidden');
            }
        });

    </script>
</body>
</html>
