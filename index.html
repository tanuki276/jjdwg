<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>liefantidia | æ­´å²çš„æ——ãƒ»ç´‹ç« æ¤œç´¢</title> 
    
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f9;
            color: #333;
        }
        header {
            background-color: #004d99;
            color: white;
            padding: 20px;
            text-align: center;
        }
        main {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        /* æ¤œç´¢ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« */
        .search-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            flex-wrap: wrap;
        }
        .search-controls input, 
        .search-controls select, 
        .search-controls button {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
            flex-grow: 1;
        }
        .search-controls button {
            background-color: #cc0000;
            color: white;
            cursor: pointer;
            border: none;
            transition: background-color 0.3s;
        }
        .search-controls button:hover {
            background-color: #990000;
        }
        /* æ¤œç´¢çµæœã‚¨ãƒªã‚¢ */
        .flags-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }
        .flag-card {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            text-align: center;
            border-left: 5px solid #004d99;
        }
        .flag-card img {
            max-width: 100%;
            height: auto;
            max-height: 150px;
            border: 1px solid #eee;
            margin-bottom: 5px;
        }
        .flag-card h3 {
            font-size: 1.1em;
            margin: 5px 0;
        }
        .flag-card p {
            font-size: 0.9em;
            color: #666;
            line-height: 1.4;
        }
        /* ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .flag-card button {
            margin-top: 5px; 
            padding: 5px 10px; 
            background-color: #007bff; 
            color: white; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.2s;
        }
        .flag-card button:hover {
            background-color: #0056b3;
        }
        /* ãƒ©ã‚¤ã‚»ãƒ³ã‚¹æƒ…å ± */
        .license-info {
            margin-top: 10px;
            padding-top: 5px;
            border-top: 1px dotted #ccc;
            font-size: 0.75em;
            color: #004d99;
        }
        .license-info a {
            color: #004d99;
            text-decoration: none;
        }
        .license-info a:hover {
            text-decoration: underline;
        }
        .hidden {
            display: none;
        }
        .error {
            color: red;
            font-weight: bold;
            text-align: center;
            padding: 20px;
        }
        footer {
            text-align: center;
            padding: 15px;
            margin-top: 30px;
            border-top: 1px solid #ddd;
            font-size: 0.8em;
            color: #666;
        }
    </style>
</head>
<body>

    <header>
        <h1>liefantidia | æ­´å²çš„æ——ãƒ»ç´‹ç« æ¤œç´¢</h1> 
        <p>å›½åã€æ”¿ä½“åã€ã¾ãŸã¯æ——ã®ç¨®é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚å¹´å·æŒ‡å®šã¯ç¾åœ¨éå¯¾å¿œã§ã™ã€‚</p>
    </header>

    <main>
        <section class="search-controls">
            <input type="text" id="keyword-input" placeholder="å›½åã‚„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ (ä¾‹: æ¸…æœ, ãƒ‰ã‚¤ãƒ„)" aria-label="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢">
            
            <input type="number" id="year-input" placeholder="å¹´å· (éå¯¾å¿œ)" min="1" max="2025" aria-label="å¹´å·æŒ‡å®š" style="display: none;">
            
            <select id="flag-type-select" aria-label="æ——ã®ç¨®é¡é¸æŠ">
                <option value="">å…¨ã¦ã®ç¨®é¡ (æ——ã¨ç´‹ç« )</option>
                <option value="å›½æ——">å›½æ——</option>
                <option value="è»æ——">è»æ——</option>
                <option value="å•†èˆ¹æ——">å•†èˆ¹æ——</option>
                <option value="æ”¿å…šæ——">æ”¿å…šæ——</option>
                <option value="å›½ç« ">å›½ç« </option>
                <option value="è»è‰¦æ——">è»è‰¦æ——</option>
            </select>

            <button id="search-button">æ¤œç´¢</button>
        </section>

        <section class="results-area">
            <h2>æ¤œç´¢çµæœ (<span id="result-count">0</span>ä»¶)</h2>
            <p id="loading-message" class="hidden">æ¤œç´¢ä¸­... (Wikidata Query Serviceã«ç›´æ¥å•ã„åˆã‚ã›ã¦ã„ã¾ã™)</p>
            <p id="error-message" class="hidden error">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚å…¥åŠ›å†…å®¹ã‚’ç¢ºèªã—ã€æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚</p>
            <p id="local-data-note" class="hidden" style="color:#990000; font-size: 0.9em; text-align: center;">â€»ã“ã®çµæœã¯ãƒ­ãƒ¼ã‚«ãƒ«ï¼ˆäºˆå‚™ï¼‰ãƒ‡ãƒ¼ã‚¿ãŒè£œå®Œã—ã¦ã„ã¾ã™ã€‚</p>
            
            <div id="flags-container" class="flags-grid">
            </div>
        </section>
    </main>

    <footer>
        <p>ãƒ‡ãƒ¼ã‚¿ã¯**Wikidata**ãŠã‚ˆã³**Wikimedia Commons**ã‹ã‚‰å–å¾—ã•ã‚Œã¦ã„ã¾ã™ã€‚</p>
        <p>è‡ªç”±ãªãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã«åŸºã¥ãè¡¨ç¤ºã—ã¦ã„ã¾ã™ãŒã€**å¿…ãšå„ã‚«ãƒ¼ãƒ‰ã®å‡ºå…¸ã‚’ã”ç¢ºèªãã ã•ã„ã€‚**</p>
    </footer>

    <script>
        const WIKIDATA_ENDPOINT = 'https://query.wikidata.org/sparql';
        const LOCAL_DATA_FILE = './local_flags_supplement.json'; // äºˆå‚™ãƒ‡ãƒ¼ã‚¿ã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹
        let localFlagsData = [];

        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€åº¦ã ã‘èª­ã¿è¾¼ã‚€
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch(LOCAL_DATA_FILE);
                if (response.ok) {
                    localFlagsData = await response.json();
                    console.log(`ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ ${localFlagsData.length} ä»¶ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚`);
                } else {
                    console.warn('ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã‹ã€èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                }
            } catch (e) {
                console.error('ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
            }
        });

        // =======================================================
        // ğŸ› ï¸ Wikidata SPARQLã‚¯ã‚¨ãƒªã¨æ•´å½¢ãƒ­ã‚¸ãƒƒã‚¯ (æ¤œç´¢ç²¾åº¦å‘ä¸Šæ¸ˆã¿)
        // =======================================================

        function generateSparqlQuery(keyword, year, type) {
            if (!keyword) return null;

            // ğŸŒŸ ä¿®æ­£æ¸ˆã¿: P31(ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹)ã§ã€Œæ——ã€ã¾ãŸã¯ã€Œç´‹ç« ã€ã‚’ç›´æ¥æ¢ã—ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ä¸€è‡´ã‚’å¼·åŒ–
            const sparqlQuery = `
                SELECT DISTINCT 
                    ?item ?itemLabel ?image ?licenseLabel ?authorLabel
                    (SAMPLE(?startDate) AS ?start)
                    (SAMPLE(?endDate) AS ?end)
                    (SAMPLE(?type) AS ?typeLabel)
                WHERE {
                    # 1. æ¢ã—ã¦ã„ã‚‹ã‚¢ã‚¤ãƒ†ãƒ  ?item ã¯ã€æ—— (Q1197825) ã‹ç´‹ç«  (Q1529158) ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã§ã‚ã‚‹ã“ã¨
                    { ?item wdt:P31/wdt:P279* wd:Q1197825. } # æ—— (Q1197825)
                    UNION
                    { ?item wdt:P31/wdt:P279* wd:Q1529158. } # å›½ç« /ç´‹ç«  (Q1529158)
                    
                    # 2. æ——/ç´‹ç« ã®ç”»åƒURLã‚’å–å¾—
                    { ?item wdt:P41 ?image. } # æ——ã®ç”»åƒ
                    UNION
                    { ?item wdt:P94 ?image. } # ç´‹ç« ã®ç”»åƒ
                    
                    # 3. ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒãƒãƒ³ã‚° (UNIONã§ã€ã‚ˆã‚Šåºƒããƒ’ãƒƒãƒˆã•ã›ã‚‹)
                    {
                        # A. æ——/ç´‹ç« è‡ªèº«ã®ãƒ©ãƒ™ãƒ«ã«ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã‚‹
                        ?item rdfs:label ?itemLabel.
                        FILTER(LANG(?itemLabel) = "ja" || LANG(?itemLabel) = "en").
                        FILTER(CONTAINS(LCASE(?itemLabel), LCASE("${keyword}"))).
                    }
                    UNION
                    {
                        # B. æ——/ç´‹ç« ãŒæ‰€å±ã™ã‚‹å›½/æ”¿ä½“ (P17) ã®ãƒ©ãƒ™ãƒ«ã«ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã‚‹
                        ?item wdt:P17 ?country.
                        ?country rdfs:label ?countryLabel.
                        FILTER(LANG(?countryLabel) = "ja" || LANG(?countryLabel) = "en").
                        FILTER(CONTAINS(LCASE(?countryLabel), LCASE("${keyword}"))).
                    }
                    
                    # 4. ãã®ä»–ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§å–å¾— (æœŸé–“ã€ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã€ä½œè€…)
                    OPTIONAL { ?item wdt:P170 ?author. } 
                    OPTIONAL { ?item wdt:P6216 ?license. } 
                    OPTIONAL { ?item wdt:P580 ?startDate. } 
                    OPTIONAL { ?item wdt:P582 ?endDate. } 
                    
                    SERVICE wikibase:label { 
                        bd:serviceParam wikibase:language "[AUTO_LANGUAGE],ja,en".
                        ?item rdfs:label ?itemLabel.
                        OPTIONAL { ?item wdt:P31 ?typeQID. ?typeQID rdfs:label ?type. }
                        OPTIONAL { ?license rdfs:label ?licenseLabel. }
                        OPTIONAL { ?author rdfs:label ?authorLabel. }
                    }
                }
                GROUP BY ?item ?itemLabel ?image ?licenseLabel ?authorLabel
                LIMIT 50
            `;
            return sparqlQuery;
        }

        function transformWikidataResponse(data) {
            if (!data.results || !data.results.bindings) return [];

            const flags = data.results.bindings.map(binding => {
                let licenseName = binding.licenseLabel?.value || 'ä¸æ˜ãªãƒ©ã‚¤ã‚»ãƒ³ã‚¹';
                let licenseUrl = '';
                
                if (licenseName.includes('Creative Commons')) {
                    licenseUrl = 'https://creativecommons.org/licenses/by-sa/4.0/deed.ja';
                } else if (licenseName.includes('Public Domain')) {
                    licenseUrl = 'https://ja.wikipedia.org/wiki/%E3%83%91%E3%83%96%E3%83%AA%E3%83%83%E3%82%AF%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3';
                }

                let startDate = binding.start?.value ? new Date(binding.start.value).getFullYear() : 'ä¸æ˜';
                let endDate = binding.end?.value ? new Date(binding.end.value).getFullYear() : null;
                let typeLabel = binding.typeLabel?.value || 'æ——/ç´‹ç« ';
                let simpleType = typeLabel.includes('ç´‹ç« ') || typeLabel.includes('Coat of arms') ? 'å›½ç« ' : 'æ——';

                const id = binding.itemLabel?.value + '_' + startDate; 
                
                return {
                    id: id,
                    name: binding.itemLabel?.value || 'åç§°ä¸æ˜',
                    type: simpleType,
                    start_year: startDate,
                    end_year: endDate,
                    image_url: binding.image?.value,
                    license_name: licenseName,
                    license_url: licenseUrl,
                    author: binding.authorLabel?.value || 'ä¸æ˜',
                    source: 'Wikidata'
                };
            });
            
            return flags;
        }

        // =======================================================
        // ğŸ’¾ ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿æ¤œç´¢ãƒ­ã‚¸ãƒƒã‚¯ (äºˆå‚™)
        // =======================================================
        
        function searchLocalData(keyword) {
            if (localFlagsData.length === 0) return [];

            const lowerKeyword = keyword.toLowerCase();
            const results = localFlagsData.filter(flag => {
                return flag.keywords_ja.some(k => k.toLowerCase().includes(lowerKeyword)) || 
                       flag.name_ja.toLowerCase().includes(lowerKeyword);
            });

            return results.map(flag => ({
                id: 'local_' + flag.name_ja,
                name: flag.name_ja,
                type: flag.type || 'æ——/ç´‹ç«  (ãƒ­ãƒ¼ã‚«ãƒ«)',
                start_year: flag.start_year || 'ä¸æ˜', 
                end_year: flag.end_year || null,
                image_url: flag.image_path,
                license_name: flag.license_name || 'è¦ç¢ºèª',
                license_url: flag.license_url || '#',
                author: flag.author || 'ä¸æ˜',
                source: flag.metadata_source || 'Local File'
            }));
        }

        // =======================================================
        // ğŸ¨ è¡¨ç¤ºå‡¦ç†é–¢æ•° (DOWNLOAD LINKå¯¾å¿œæ¸ˆã¿)
        // =======================================================

        function renderFlags(flags, container) {
            container.innerHTML = '';
            flags.forEach(flag => {
                const card = document.createElement('div');
                card.className = 'flag-card';
                
                const imageUrl = flag.image_url || 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-size="10" fill="#cc0000">ç”»åƒæ¬ è½</text><rect x="0" y="0" width="100" height="100" fill="none" stroke="#ccc" stroke-width="2"/></svg>';
                
                const safeFileName = `${flag.name.replace(/[^a-zA-Z0-9\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]/g, '_')}_${flag.start_year}`;

                // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ã®æ§‹é€ 
                const downloadSection = `
                    <a href="${imageUrl}" download="${safeFileName}.svg" title="${flag.name}ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰">
                        <img src="${imageUrl}" alt="${flag.name}">
                    </a>
                    <button onclick="window.open('${imageUrl}', '_blank')">ç”»åƒã‚’åˆ¥ã‚¿ãƒ–ã§é–‹ã</button>
                `;

                // ã‚«ãƒ¼ãƒ‰ã®ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„
                card.innerHTML = `
                    ${downloadSection}
                    <h3>${flag.name}</h3>
                    <p>ç¨®é¡: ${flag.type || 'ä¸æ˜'}</p>
                    <p>æœŸé–“: ${flag.start_year || 'ä¸æ˜'} - ${flag.end_year || 'ç¾è¡Œ'}</p>
                    <p style="font-size: 0.8em; color: #004d99;">ãƒ‡ãƒ¼ã‚¿å…ƒ: ${flag.source}</p>
                `;
                
                // ãƒ©ã‚¤ã‚»ãƒ³ã‚¹æƒ…å ±
                const licenseInfo = document.createElement('p');
                licenseInfo.className = 'license-info';
                
                let licenseText = 'å‡ºå…¸: ';
                licenseText += flag.author ? `ä½œè€…: ${flag.author}` : `æƒ…å ±æº`;
                
                if (flag.license_name && flag.license_url) {
                    licenseText += `, <a href="${flag.license_url}" target="_blank">${flag.license_name}</a>`;
                } else if (flag.license_name) {
                    licenseText += `, ${flag.license_name}`;
                }

                licenseInfo.innerHTML = licenseText;
                card.appendChild(licenseInfo);
                
                container.appendChild(card);
            });
        }
        
        // =======================================================
        // ğŸ–±ï¸ ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ (æ¤œç´¢å®Ÿè¡Œéƒ¨)
        // =======================================================

        document.getElementById('search-button').addEventListener('click', async () => {
            const keyword = document.getElementById('keyword-input').value.trim();
            const type = document.getElementById('flag-type-select').value;

            const flagsContainer = document.getElementById('flags-container');
            const resultCount = document.getElementById('result-count');
            const loadingMessage = document.getElementById('loading-message');
            const errorMessage = document.getElementById('error-message');
            const localDataNote = document.getElementById('local-data-note');

            // è¡¨ç¤ºã‚’ãƒªã‚»ãƒƒãƒˆ
            flagsContainer.innerHTML = '';
            resultCount.textContent = '0';
            errorMessage.classList.add('hidden');
            localDataNote.classList.add('hidden');
            loadingMessage.classList.remove('hidden');

            const sparqlQuery = generateSparqlQuery(keyword, null, type);

            if (!sparqlQuery) {
                loadingMessage.classList.add('hidden');
                errorMessage.textContent = "æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
                errorMessage.classList.remove('hidden');
                return;
            }
            
            let structuredFlags = [];
            let finalFlags = [];
            let usedLocalFallback = false;

            try {
                // 1. Wikidataæ¤œç´¢ (ãƒ—ãƒ©ã‚¤ãƒãƒª)
                const response = await fetch(WIKIDATA_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/sparql-results+json',
                        'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'
                    },
                    body: `query=${encodeURIComponent(sparqlQuery)}`
                });

                if (!response.ok) throw new Error(`Wikidataæ¥ç¶šã‚¨ãƒ©ãƒ¼ (HTTP ${response.status})`); 

                const data = await response.json();
                structuredFlags = transformWikidataResponse(data); 

            } catch (error) {
                console.error('Wikidataæ¤œç´¢ã«å¤±æ•—:', error);
                // è‡´å‘½çš„ãªã‚¨ãƒ©ãƒ¼ã®å ´åˆã€ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                finalFlags = searchLocalData(keyword);
                usedLocalFallback = true;
            }

            // 2. çµæœã®çµåˆã¨è£œå®Œ
            if (structuredFlags.length > 0) {
                const localMap = new Map();
                searchLocalData(keyword).forEach(flag => localMap.set(flag.name, flag));
                
                structuredFlags.forEach(flag => {
                    if (!flag.image_url) {
                        const localFlag = localMap.get(flag.name);
                        if (localFlag) {
                            flag.image_url = localFlag.image_url;
                            flag.license_name = flag.license_name === 'ä¸æ˜ãªãƒ©ã‚¤ã‚»ãƒ³ã‚¹' ? localFlag.license_name : flag.license_name;
                            flag.source = 'Wikidata (ç”»åƒ:Local)';
                            localMap.delete(flag.name); 
                        }
                    }
                    finalFlags.push(flag);
                });

                localMap.forEach(flag => finalFlags.push(flag));
                
            } else if (!usedLocalFallback) { 
                finalFlags = searchLocalData(keyword);
                usedLocalFallback = true;
            }

            // 3. è¡¨ç¤º
            loadingMessage.classList.add('hidden');
            
            // é‡è¤‡æ’é™¤ (IDãƒ™ãƒ¼ã‚¹)
            const uniqueFlags = Array.from(new Map(finalFlags.map(item => [item.id, item])).values());

            resultCount.textContent = uniqueFlags.length;
            renderFlags(uniqueFlags, flagsContainer);
            
            if (usedLocalFallback && uniqueFlags.length > 0) {
                localDataNote.classList.remove('hidden');
            } else if (uniqueFlags.length === 0) {
                errorMessage.textContent = 'è©²å½“ã™ã‚‹æ——ãƒ»ç´‹ç« ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚';
                errorMessage.classList.remove('hidden');
            }
        });

    </script>
</body>
</html>
